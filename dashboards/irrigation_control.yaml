title: "Irrigation Control"
views:
  - title: "Control"
    path: control
    icon: mdi:sprinkler-variant

    cards:
      # ────────── Row 1 ────────────────────────────────────────────
      - type: vertical-stack
        title: "Row 1"
        cards:
          # System overview (compact) – pump entity can be changed dynamically
          - type: custom:config-template-card
            update_interval: 1
            variables:
              pump: states['input_select.irrigation_relay_entity'].state
            entities:
              - input_select.irrigation_relay_entity
              - sensor.irrigation_power
            card:
              type: glance
              title: "System"
              show_state: true
              entities:
                - entity: "${pump}"
                  name: "Pump"
                - entity: sensor.irrigation_power
                  name: "Actual Power"
          # Manual irrigation trigger (sets Reason=Manual)
          - type: button
            name: "Manual Irrigation"
            icon: mdi:water-pump
            tap_action:
              action: call-service
              service: script.irrigation_run_manual

          - type: horizontal-stack
            cards:
              # Minutes since last Irrigation gauge (dynamic threshold)
              - type: custom:config-template-card
                variables:
                  threshold: states['input_number.irrigation_fallback_minutes'].state
                entities:
                  - sensor.time_since_last_irrigation_min
                  - input_number.irrigation_fallback_minutes
                card:
                  type: gauge
                  entity: sensor.time_since_last_irrigation_min
                  needle: true
                  min: 0
                  max: ${Number(threshold) + 10}
                  name: since last irrigation
                  segments:
                    - from: 0
                      color: "#9e9e9e"
                    - from: ${Number(threshold)}
                      color: "#00bcd4"
                      label: Irrigation

              # Radiation gauge (dynamic threshold)
              - type: custom:config-template-card
                variables:
                  threshold: states['sensor.radiation_threshold_current'].state
                entities:
                  - sensor.radiation_threshold_current
                  - sensor.radiation_since_irrigation
                card:
                  type: gauge
                  entity: sensor.radiation_since_irrigation
                  min: 0
                  max: ${Number(threshold) + 10}
                  needle: true
                  segments:
                    - from: 0
                      color: "#9e9e9e"
                    - from: ${Number(threshold)}
                      color: "#00bcd4"
                      label: Irrigation

          # Reason timeline (history)
          - type: history-graph
            title: "History"
            hours_to_show: 8
            refresh_interval: 60
            entities:
              - entity: input_select.irrigation_last_reason
                name: Reason

          - type: logbook
            title: Letzte Bewässerungsvorgänge (24h)
            hours_to_show: 24
            entities:
              - script.irrigation_run

      # ────────── Weatherstation ──────────────────────────────────
      - type: vertical-stack
        title: "Weatherstation"
        cards:
          - type: horizontal-stack
            cards:
              - type: sensor
                entity: sensor.global_radiation_energy
                name: "Global Radiation Energy"
                graph: line
                unit: "Wh/m²"

              - type: sensor
                entity: sensor.gw3000a_solar_radiation
                name: Global Radiation
                graph: line
                detail: 2
                hours_to_show: 24
